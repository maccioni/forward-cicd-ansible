- name: Verify changes in the Forward Enterprise Sandox

  hosts: localhost
  gather_facts: no

  vars_files:
    - /var/lib/jenkins/forward.properties

  tasks:

      #### Step 1: fork the given snapshot ####
    - name: Fork current snapshot
      uri:
        url: "{{url}}/api/snapshots/{{snapshotId}}/fork?snapshotName=cicd-testing"
        method: POST
        force_basic_auth: yes
        user: "{{ username }}"
        password: "{{ password }}"
        body_format: json
        return_content: yes
      register: fork_output

    - name: Print Snapshot Fork info
      debug:
        msg:
          - "API URL: {{ fork_output.url }}"
          - "API Status: {{ fork_output.status }}"
          - "Fork id: {{ fork_output.json.id }}"

    #### Step 2: Save changes into Sanbox by uploading the new device config ####
    - name: Save changes into Sandox
      shell: 'curl  -X "POST" "{{url}}/api/snapshots/{{fork_output.json.id}}/files" -u {{ username }}:{{ password }} -F "file=@/var/lib/jenkins/{{ device_name }}_config.txt"  -k'
      register: save_output

    #### Step 3: Commit change to Sandbox  ####
    - name: Commit changes in Sandox
      uri:
        url: "{{url}}/api/snapshots/{{fork_output.json.id}}/commit?changed"
        method: POST
        force_basic_auth: yes
        user: "{{ username }}"
        password: "{{ password }}"
        body_format: json
        return_content: yes
      register: commit_output

    - name: set ansible variable with new snapshot id
      set_fact:
        predict_snapshot_id: {{ commit_output.json.id }}

    - name: Print Commit Changes info
      debug:
        msg:
          - "API URL: {{ commit_output.url }}"
          - "API Status: {{ commit_output.status }}"
          - "New snapshot id: {{ commit_output.json.id }}"
