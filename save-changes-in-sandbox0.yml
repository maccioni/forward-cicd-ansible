- name: Verify changes in the Forward Enterprise Sandox

  hosts: localhost
  gather_facts: no

  vars_files:
    - /Users/fabriziomaccioni/src/forward-cicd-ansible/forward.properties

  tasks:

      #### Step 1: fork the given snapshot ####
    - name: Fork current snapshot
      uri:
        url: https://{{base_url}}/snapshots/{{snapshotId}}/fork?snapshotName=cicd-testing
        method: POST
        force_basic_auth: yes
        user: "{{ username }}"
        password: "{{ password }}"
        body_format: json
        return_content: yes
      register: fork_output

    - name: Print Snapshot Fork info
      debug:
        msg:
          - "API Status: {{ fork_output.status }}"
          - "API URL: {{ fork_output.url }}"
          - "Fork id: {{ fork_output.json.id }}"

    #### Step 2: Save changes into Sanbox by uploading the new device config ####
    - name: Save changes into Sandox
      shell: 'curl  -X "POST" "https://{{base_url}}/snapshots/{{fork_output.json.id}}/files" -u {{ username }}:{{ password }} -F "file=@/Users/fabriziomaccioni/Documents/Events/2019/NetworkingFiledDay21/API-testing/{{ device_name }}_config.txt"  -k'
      register: save_output

    - name: Print Save Changes info
      debug:
        msg:
          - "Save output: {{ save_output }}"
#          - "id: {{ save_output.id }}"
#          - "Filename: {{ save_output.filename }}"

    - name: Commit changes in Sandox
      uri:
        url: https://{{base_url}}/snapshots/{{fork_output.json.id}}/commit?changed
        method: POST
        force_basic_auth: yes
        user: "{{ username }}"
        password: "{{ password }}"
        body_format: json
        return_content: yes
      register: commit_output
#      failed_when: collection_output.json.info.paths[0].forwardingOutcome != expected_forwarding_outcome_status

    - name: Print Commit Changes info
      debug:
        msg:
          - "API Status: {{ commit_output.status }}"
          - "API URL: {{ commit_output.url }}"
          - "Commit output: {{ commit_output }}"
